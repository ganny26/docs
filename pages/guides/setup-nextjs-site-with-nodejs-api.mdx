import Guide from '~/components/layout/guide'
import { TerminalInput } from '~/components/text/terminal'
import { InlineCode } from '~/components/text/code'
import Caption from '~/components/text/caption'
import Note from '~/components/text/note'
import { GenericLink } from '~/components/text/link'
import Card from '~/components/card'

export const meta = {
  title: 'Setup a Next.js project with Node.js API integration',
  description: 'Creating a Next.js Application with Node.js API',
  published: '2019-04-19T03:00:00.860Z',
  authors: ['ganny26'],
  url: '/guides/setup-nextjs-site-with-nodejs-api',
  editUrl: 'pages/guides/setup-nextjs-site-with-nodejs-api.mdx',
  lastEdited: '2019-04-20T07:34:08.000Z'
}

In this guide, we will cover how to deploy Next.js application with Node js API.

## Step 1: Set Up Your Next.js Project

First, create a directory for this project `nextjs-node-api` and [`cd`](<https://en.wikipedia.org/wiki/Cd_(command)>) into it:

<TerminalInput>mkdir nextjs-node-api && cd nextjs-node-api</TerminalInput>

Create a `package.json` using `yarn init --yes` or `npm init --yes` and then install the required dependencies from your terminal:

<TerminalInput>yarn add next react react-dom</TerminalInput>
<Caption>Installing Next.js, React, and React DOM with Yarn. Alternatively, use <GenericLink href="https://nextjs.org/docs/#setup">npm</GenericLink>.</Caption>

The next step in this set up is to add a `scripts` property to the `package.json` file that was generated in the installation above. The property will [include a script to run a local server](https://nextjs.org/docs/#setup) for development of your project:

```json
{
  ...
  "scripts": {
    "dev": "next"
  }
}
```

<Caption>
  A <InlineCode>scripts</InlineCode> property within a{' '}
  <InlineCode>package.json</InlineCode>, containing a script to start a Next.js
  development server.{' '}
</Caption>

Now the initial set up of your Next.js project is done, you are ready to create your first page.

Create a `pages` directory and then within that directory, create an `index.js` for the homepage with the following contents:

```js
function Index() {
  return <div>Welcome to Next.js!</div>
}

export default Index
```

<Caption>A simple Next.js index page located in the pages directory.</Caption>

You can then run your new Next.js project with the following command

<TerminalInput>yarn dev</TerminalInput>
<Caption>Running a local development server with the script set up earlier.</Caption>

You can now start developing your Next.js application while testing it locally.

## Step 2: Setup Node.js API

To create a node js api let's add Express JS npm module

<TerminalInput>yarn add express</TerminalInput>

Now create a seperate directory for Node JS API using following command

<TerminalInput>mkdir api && cd api</TerminalInput>

Create a new file `index.js` inside api folder with the following contents:

```js
const app = require('express')()

app.get('/api', (req, res) => {
  res.send('Hello from Express.js!')
})

app.listen()
```

## Step 3: Fetching Data for Pages from Node JS API

First of all we need to install `isomorphic-unfetch`. That's the library we are going to use to fetch data. It's a simple implementation of the browser fetch API, but works both in client and server environments.

<TerminalInput>yarn add isomorphic-unfetch</TerminalInput>

Then replace our `pages/index.js` with the following content:

```js
import fetch from 'isomorphic-unfetch'

function Index(props) {
  return <div>{props.result}</div>
}

Index.getInitialProps = async function({ err, res, xhr, req }) {
  const BASE_URL = req.headers['x-now-deployment-url']
  const result = await fetch(`https://${BASE_URL}/api`)
  const data = await result.text()

  return {
    result: data
  }
}

export default Index
```

## Step 4: Deploy Your Next.js Project & Node.js Project with Now

With your Next.js project set up, you are ready to deploy your app with Now.

The first step of deploying Next.js with Now is to create a `next.config.js` file to tell Next that the files it will build are serverless. Each page will be built as an individual serverless lambda.

```js
module.exports = {
  target: 'serverless'
}
```

Next, you will need to tell Now what the entrypoint is for the application and what Builder it should use to build and deploy the application so it will act as you would expect.

You will need to create a now.json configuration file to instruct Now on how to handle your application in the build phase and when being served to visitors.

```json
{
  "version": 2,
  "name": "nextjs-nodejs-app",
  "builds": [
    {
      "src": "next.config.js",
      "use": "@now/next",
      "config": { "maxLambdaSize": "20mb" }
    },
    {
      "src": "./api/index.js",
      "use": "@now/node-server",
      "config": { "maxLambdaSize": "20mb" }
    }
  ]
}
```

To ensure a fresh build of your Next.js project gets built by Now, especially if you only deploy the source code, you can add a now-build script to your package.json file:

```json
{
  ...
  "scripts": {
    ...
    "now-build": "next build"
  }
}
```

<Note>
  Don't forget to exclude the <InlineCode>.next</InlineCode> and{' '}
  <InlineCode>node_modules</InlineCode> directories from being uploaded to Now
  to prevent unintended side effects and to enable faster deployment. To do so,
  add a{' '}
  <GenericLink href="/guides/prevent-uploading-sourcepaths-with-nowignore/">
    .nowignore
  </GenericLink>{' '}
  file to the root of the project directory and add both{' '}
  <InlineCode>node_modules</InlineCode> and <InlineCode>.next</InlineCode> to it
  on separate lines.
</Note>

### Deploying with Now

You are now ready to deploy the app with Now:

<TerminalInput>now</TerminalInput>
<Caption>Deploying your Next.js app with Now CLI from a terminal.</Caption>

Once the app is deployed, you will receive a deployment URL similar to the following (styled for effect, with an additional page): <https://my-nextjs-app.selvaganesh93.now.sh/>

## Resources

For more information on working with Next.js, please refer to [the Next.js documentation](https://nextjs.org/docs).

To configure Now further, please see these additional topics and guides:

<Card title="Deploying Basics" href="/docs/v2/deployments/basics">
  Deploy any of your applications with ZEIT Now.
</Card>

<Card
  title="@now/next Builder"
  href="/docs/v2/deployments/official-builders/next-js-now-next"
>
  The Now Builder for Next.js.
</Card>

<Card
  title="Deploying with Custom Next.js Routes"
  href="/guides/custom-next-js-server-to-routes"
>
  Custom Routes with Next.js and Now
</Card>

<Card
  title="Aliasing"
  href="/docs/v2/domains-and-aliases/aliasing-a-deployment/"
>
  Learn more about aliasing to your deployments.
</Card>

<Card title="More Guides" href="/guides">
  See more guides that help you move forward with your projects and deployments.
</Card>

export default ({ children }) => <Guide meta={meta}>{children}</Guide>
